# SPDX-FileCopyrightText: 2025 UnionTech Software Technology Co., Ltd.
#
# SPDX-License-Identifier: LGPL-3.0-or-later
version: "1"
package:
  id: cn.org.linyaps.builder.utils
  name: ll-builder-utils
  version: 0.0.1.3
  kind: app
  description: |
    Utils for ll-builder

command: [/opt/apps/cn.org.linyaps.builder.utils/files/bin/ll-builder-export]

base: org.deepin.base/25.2.1
sources:
  - kind: archive
    url: https://github.com/erofs/erofs-utils/archive/refs/tags/v1.8.6.tar.gz
    digest: 5b221dc3fd6d151425b30534ede46fb7a90dc233a8659cba0372796b0a066547
    name: erofs-utils
  - kind: archive
    url: https://github.com/libfuse/libfuse/releases/download/fuse-3.17.1/fuse-3.17.1.tar.gz
    digest: 2d8ae87a4525fbfa1db5e5eb010ff6f38140627a7004554ed88411c1843d51b2
    name: fuse
  - kind: archive
    url: https://github.com/OpenAtom-Linyaps/linyaps-box/archive/refs/tags/2.1.2.tar.gz
    digest: 70c908e3a2397d195d64d606b886c9635b13a461beea70a6cc5317e0bb6e9589
    name: linyaps-box
  - kind: archive
    url: https://github.com/OpenAtom-Linyaps/linyaps/archive/refs/tags/1.11.1.tar.gz
    digest: 9c859c31f21c17861ca80b95847e4b28121e66220391b6d35dd2e6c68778c307
    name: linyaps
build: |
  echo "$PREFIX"

  FUSE_TAG="3.17.1"
  EROFS_UTILS_TAG="1.8.6"
  LINYAPS_BOX_TAG="2.1.2"
  LINYAPS_TAG="1.11.1"

  # build libfuse static library
  cd /project/linglong/sources/fuse/fuse-${FUSE_TAG}
  patch lib/mount.c /project/linglong/sources/linyaps/linyaps-${LINYAPS_TAG}/apps/ll-builder-utils/patch/libfuse.patch
  mkdir build || true
  cd build
  meson setup ../
  meson configure --default-library static -D utils=false -D examples=false -D tests=false -D disable-libc-symbol-version=false
  ninja && ninja install

  # build erofsfuse static library
  cd /project/linglong/sources/erofs-utils/erofs-utils-${EROFS_UTILS_TAG}
  ./autogen.sh
  ./configure -with-libzstd --enable-fuse --enable-static-fuse --with-libdeflate --without-xxhash libdeflate_LIBS=-ldeflate libdeflate_CFLAGS=-ldeflate
  make -j$(nproc)
  make install

  # build static ll-box
  cd /project/linglong/sources/linyaps-box/linyaps-box-${LINYAPS_BOX_TAG}/
  sed -i 's/"version": 10/"version": 6/g' CMakePresets.json
  cmake --workflow --preset static
  cmake --install build-static --prefix=$PREFIX

  cd /project/linglong/sources/linyaps/linyaps-${LINYAPS_TAG}/
  cmake -B build-linglong -DCPM_LOCAL_PACKAGES_ONLY=true -DENABLE_TESTING=false -DBUILD_LINGLONG_BUILDER_UTILS_IN_BOX=true -DAGGRESSIVE_UAB_SIZE=ON
  cmake --build build-linglong -j$(nproc)
  cmake --install build-linglong --prefix=$PREFIX
  install /usr/local/bin/mkfs.erofs $PREFIX/bin/
buildext:
  apt:
    build_depends: [patch, meson, libtool, pkg-config, uuid-dev, libdeflate-dev, libzstd-dev, nlohmann-json3-dev, libyaml-cpp-dev, liblz4-dev, liblzma-dev, libselinux1-dev, libpcre2-dev, libelf-dev, libcap-dev, libcli11-dev, libgtest-dev]
